<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>CSS Vertex Demo 2: Transformed Face</title>
    <link rel="stylesheet" href="../base.css">
    <style>
        .vertex, .face {
            position: absolute;
            top: 50%;
            left: 50%;
            -webkit-transform-style: preserve-3d;
            -moz-transform-style: preserve-3d;
            -ms-transform-style: preserve-3d;
            transform-style: preserve-3d;
        }
        .face {
            background-color: rgba(50, 40, 60, .25);
        }
        .vertex {
            width: 9px;
            height: 9px;
            margin: -4px;
            background: rgba(255, 0, 0, .5);
            border-radius: 7px;
            color: #333;
            font: 10px / 1 "Courier New", monospace;
            text-indent: 14px;
            white-space: nowrap;
        }
        #scene {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            -webkit-perspective: 400px;
            -moz-perspective: 400px;
            -ms-perspective: 400px;
            perspective: 400px;
            -webkit-transform-style: preserve-3d;
            -moz-transform-style: preserve-3d;
            -ms-transform-style: preserve-3d;
            transform-style: preserve-3d;
        }
        #test-face {
            width: 300px;
            height: 200px;
            margin: -100px -150px;
            -webkit-transform: rotateY(45deg) rotateX(45deg);
            -moz-transform: rotateY(45deg) rotateX(45deg);
            -ms-transform: rotateY(45deg) rotateX(45deg);
            transform: rotateY(45deg) rotateX(45deg);
        }
    </style>
</head>
<body>
    <header>
        <h1>CSS Vertex Demo 2: Transformed Face</h1>
    </header>

    <div id="scene">
        <div id="test-face" class="face"></div>
    </div>

    <footer>
        Please see the accompanying <a href="../../../../../../calculating-element-vertex-data-from-css-transforms/index.html">blog post</a>
	or discuss on <a href="http://twitter.com/keithclarkcouk">twitter</a><br>
	<span class=credit>A <a href="http://keithclark.co.uk/labs">Keith Clark</a> experiment</span>
    </footer>

    <!-- 
    This script block should be in an external file but I've inlined it to 
    make the source code easier to follow.
    -->
    <script>
        /* Returns A, B, C and D vertices of an element
        ---------------------------------------------------------------- */
        
        function computeVertexData (elem) {
            var w = elem.offsetWidth,
                h = elem.offsetHeight,
                v = {
                    a: { x: -w / 2, y: -h / 2, z: 0 },
                    b: { x:  w / 2, y: -h / 2, z: 0 },
                    c: { x:  w / 2, y:  h / 2, z: 0 },
                    d: { x: -w / 2, y:  h / 2, z: 0 }
                },
                transform;
        
            while (elem.nodeType === 1) {
                transform = getTransform(elem);
                v.a = addVectors(rotateVector(v.a, transform.rotate), transform.translate);
                v.b = addVectors(rotateVector(v.b, transform.rotate), transform.translate);
                v.c = addVectors(rotateVector(v.c, transform.rotate), transform.translate);
                v.d = addVectors(rotateVector(v.d, transform.rotate), transform.translate);
                elem = elem.parentNode;
            }
            return v;
        }
        
        
        /* Returns the rotation and translation components of an element
        ---------------------------------------------------------------- */
        
        function getTransform (elem) {
            var computedStyle = getComputedStyle(elem, null),
                val = computedStyle.transform ||
                    computedStyle.webkitTransform ||
                    computedStyle.MozTransform ||
                    computedStyle.msTransform,
                matrix = parseMatrix(val),
                rotateY = Math.asin(-matrix.m13),
                rotateX, 
                rotateZ;
        
                rotateX = Math.atan2(matrix.m23, matrix.m33);
                rotateZ = Math.atan2(matrix.m12, matrix.m11);
        
            /*if (Math.cos(rotateY) !== 0) {
                rotateX = Math.atan2(matrix.m23, matrix.m33);
                rotateZ = Math.atan2(matrix.m12, matrix.m11);
            } else {
                rotateX = Math.atan2(-matrix.m31, matrix.m22);
                rotateZ = 0;
            }*/
        
            return {
                transformStyle: val,
                matrix: matrix,
                rotate: {
                    x: rotateX,
                    y: rotateY,
                    z: rotateZ
                },
                translate: {
                    x: matrix.m41,
                    y: matrix.m42,
                    z: matrix.m43
                }
            };
        }
        
        
        /* Parses a matrix string and returns a 4x4 matrix
        ---------------------------------------------------------------- */
        
        function parseMatrix (matrixString) {
            var c = matrixString.split(/\s*[(),]\s*/).slice(1,-1),
                matrix;
        
            if (c.length === 6) {
                // 'matrix()' (3x2)
                matrix = {
                    m11: +c[0], m21: +c[2], m31: 0, m41: +c[4],
                    m12: +c[1], m22: +c[3], m32: 0, m42: +c[5],
                    m13: 0,     m23: 0,     m33: 1, m43: 0,
                    m14: 0,     m24: 0,     m34: 0, m44: 1
                };
            } else if (c.length === 16) {
                // matrix3d() (4x4)
                matrix = {
                    m11: +c[0], m21: +c[4], m31: +c[8], m41: +c[12],
                    m12: +c[1], m22: +c[5], m32: +c[9], m42: +c[13],
                    m13: +c[2], m23: +c[6], m33: +c[10], m43: +c[14],
                    m14: +c[3], m24: +c[7], m34: +c[11], m44: +c[15]
                };
        
            } else {
                // handle 'none' or invalid values.
                matrix = {
                    m11: 1, m21: 0, m31: 0, m41: 0,
                    m12: 0, m22: 1, m32: 0, m42: 0,
                    m13: 0, m23: 0, m33: 1, m43: 0,
                    m14: 0, m24: 0, m34: 0, m44: 1
                };
            }
            return matrix;
        }
        
        /* Adds vector v2 to vector v1
        ---------------------------------------------------------------- */
        
        function addVectors (v1, v2) {
            return {
                x: v1.x + v2.x,
                y: v1.y + v2.y,
                z: v1.z + v2.z
            };
        }
        
        
        /* Rotates vector v1 around vector v2
        ---------------------------------------------------------------- */
        
        function rotateVector (v1, v2) {
            var x1 = v1.x,
                y1 = v1.y,
                z1 = v1.z,
                angleX = v2.x / 2,
                angleY = v2.y / 2,
                angleZ = v2.z / 2,
        
                cr = Math.cos(angleX),
                cp = Math.cos(angleY),
                cy = Math.cos(angleZ),
                sr = Math.sin(angleX),
                sp = Math.sin(angleY),
                sy = Math.sin(angleZ),
        
                w = cr * cp * cy + -sr * sp * -sy,
                x = sr * cp * cy - -cr * sp * -sy,
                y = cr * sp * cy + sr * cp * sy,
                z = cr * cp * sy - -sr * sp * -cy,
        
                m0 = 1 - 2 * ( y * y + z * z ),
                m1 = 2 * (x * y + z * w),
                m2 = 2 * (x * z - y * w),
        
                m4 = 2 * ( x * y - z * w ),
                m5 = 1 - 2 * ( x * x + z * z ),
                m6 = 2 * (z * y + x * w ),
        
                m8 = 2 * ( x * z + y * w ),
                m9 = 2 * ( y * z - x * w ),
                m10 = 1 - 2 * ( x * x + y * y );
        
            return {
                x: x1 * m0 + y1 * m4 + z1 * m8,
                y: x1 * m1 + y1 * m5 + z1 * m9,
                z: x1 * m2 + y1 * m6 + z1 * m10
            };
        }
    </script>

    <script>
 
        // Select the face
        var face = document.getElementById("test-face");

        // Compute the vertices
        var vertexData = computeVertexData(face);

        // Draw the vertices 
        renderVertex("a", face, vertexData.a);
        renderVertex("b", face, vertexData.b);
        renderVertex("c", face, vertexData.c);
        renderVertex("d", face, vertexData.d);
 

        /* Renders a vertex to the DOM
        ---------------------------------------------------------------- */

        function renderVertex (id, face, vertex) {
            var id = "_vertex_" + id,
                vertexElem = face[id],
                x = vertex.x.toFixed(2),
                y = vertex.y.toFixed(2),
                z = vertex.z.toFixed(2),
                s = 1 - vertex.z / 400; // scale to keep the text readable

            if (!vertexElem) {
                vertexElem = face[id] = document.createElement("div");
                vertexElem.className = "vertex";
                document.getElementById("scene").appendChild(vertexElem);
            }

            // show the vertex coordinates
            vertexElem.textContent = "x:" + x + " y:" + y + " z:" + z;
            
            // apply the tralsation to the vertex
            vertexElem.style.cssText = 
                "-webkit-transform: translate3d(" + x + "px," + y + "px," + z + "px) scale(" + s + ");" +
                "-moz-transform: translate3d(" + x + "px," + y + "px," + z + "px) scale(" + s + ");" +
                "-ms-transform: translate3d(" + x + "px," + y + "px," + z + "px) scale(" + s + ");" +
                "transform: translate3d(" + x + "px," + y + "px," + z + "px) scale(" + s + ");";
        }

    </script>

    <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-10812217-3']);
        _gaq.push(['_trackPageview']);
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

</body>
</html>